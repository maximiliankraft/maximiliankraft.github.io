<!DOCTYPE html>
<html>
<head>
<title>OracleCloudSetup.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="oracle-cloud-deployment">Oracle Cloud Deployment</h1>
<h2 id="setup">Setup</h2>
<p>Auf <a href="cloud.oracle.com">cloud.oracle.com</a> einen Account anlegen. Um Fake-Accounts zu verhindern verlangt Oracle eine Kreditkarte zur Identitätsfeststellung. Wir werden nur Services verwenden die nichts kosten. Als zusätzliche Absicherung bekommt man in den ersten 30 Tagen 250€ welche man für alle möglichen Ressorucen aufbrauchen kann. Sollte dieser Wert nach unten gehen ist das ein Indikator das nicht freie Services verwendet wurden. Bleibt der Wert bei 250 kann man bedenkenlos über den Testzeitraum hinaus die <code>Free-Eligibel Services</code> verwenden. Jedoch nur diese, alles andere kostet Geld.</p>
<h2 id="deployment-vorbereitungen">Deployment vorbereitungen</h2>
<p>Um unserer Software möglichst einfach installierbar zu machen werden wir sie in einen Container packen. Dazu verwenden wir Docker. Das fertige Dockerfile sollte so wie <a href="https://spring.io/guides/topicals/spring-boot-docker/">hier</a> in der Sektion <code>Multistage build</code> aussehen. Allerdings muss man mvnw gegen mvn austauschen und beim ersten FROM ein maven image nehmen. Z.b so <code>FROM maven:3-openjdk-17-slim as build</code>.</p>
<p>Um unsere Docker-Konfiguration noch leichter starbar zu machen können wir mir docker-compose mehrere Services auf einmal Konfigurieren, ihnen Volumes zuweisen, Port-Forwarding einrichten uvm. Unser Dockerfile sieht zunächst so aus:</p>
<pre class="hljs"><code><div><span class="hljs-attr">version:</span> <span class="hljs-string">"3"</span>
<span class="hljs-attr">services:</span>
    <span class="hljs-attr">api:</span>
        <span class="hljs-attr">build:</span> <span class="hljs-string">"."</span>
        <span class="hljs-attr">ports:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:8080"</span>
</div></code></pre>
<h2 id="instanz-anlegen">Instanz anlegen</h2>
<p>In <a href="cloud.oracle.com">cloud.oracle.com</a> einloggen und eine neue instanz erstellen
<img src="2022-10-31-18-08-30.png" alt=""></p>
<p>Zunächst muss man einen Namen für die Instanz festlegen. Als Basisbetriebssystem ist standardmäßig Oricle Linux ausgewählt. Wir werden mit Ubuntu arbeiten, mit einem klick auf den <code>Edit</code> Button kann man das ändern.
<img src="2022-10-31-18-09-45.png" alt=""></p>
<p>Andere Betriebssysteme wie CentOS wären auch möglich. Wichtig ist nur dass die Bezeichnung <code>Always free eligible</code> für das OS zutrifft. Ansonsten wird spätestens nach einem 30 Tage zeitraum die Nutzung verrechnet.</p>
<p><img src="2022-10-31-18-12-06.png" alt=""></p>
<p>Als nächstes müssen wir festlegen wie wir uns beim Verbindungsaufbau authentifizieren. Dazu fügen wir unseren <strong>öffentlichen</strong> SSH-Schlüssel ein.</p>
<p><img src="2022-10-31-18-13-37.png" alt=""></p>
<p>Das wars auch schon mit dem Anlegen der Instanz. Wir können mit einem Klick auf <code>Create</code> die Provisionierung beginnen.</p>
<h2 id="ssh-verbindung-%C3%B6ffnen">SSH Verbindung öffnen</h2>
<p>Zum Verbinden brauchen wir einen Usernamen, IP und ein Passwort. Das Passwort ist unser privater SSH-Schlüssel. Username und IP werden von der Oracle Cloud bereitgestellt.</p>
<p><img src="2022-10-31-18-17-37.png" alt=""></p>
<p>In dem Fall kann ich mich jetzt mit dem Befehl</p>
<p><code>ssh ubuntu@193.122.1.244 -i id_rsa</code></p>
<p>verbinden. Das generelle Schema ist</p>
<p><code>ssh &lt;username&gt;@&lt;host&gt; -i &lt;pfad-zu-ssh-private-key&gt;</code></p>
<p>Der private key liegt im Userverzeichnis im Ordner <code>.ssh</code>. Falls die Datei nicht gefunden wird kann es sein dass man den Befehl im Ordner <code>.ssh</code> ausführen muss oder den ganzen Pfad <code>-i C:\Users\&lt;dein-username&gt;\.ssh\id_rsa</code> angeben muss. Auch muss es nicht sein das die Schlüsseldatei <code>id_rsa</code> heisst. Es ist aber der Standardname.</p>
<p>Nach einem erfolgreichen Login über das SSH-Kommando sollte man eine Linux-Bash sehen:
<img src="2022-10-31-18-22-46.png" alt=""></p>
<p>Nun müssen wir noch unsere Programmdateien auf den Server bringen. Dafür gibt es das Programm <code>sftp</code>. Es routet das FTP-Protokoll über einen verschlüsselten SSH-Tunnel.</p>
<p>Wir loggen uns also mit SSH ein und starten dann das FTP-Protokoll. Der login sieht daher mit</p>
<p><code>sftp ubuntu@193.122.1.244</code></p>
<p>sehr ähnlich aus. Da der Host bereits gespeichert wurde (Datei <code>known_hosts</code> im <code>.ssh</code> Ordner) müssen wir den Schlüssel nicht noch einmal angeben. Wäre aber mit -i weiterhin möglich.</p>
<p>Unser Spring Projekt können wir in eine zip-Datei einpacken und dann via SFTP hochladen. Das können wir entweder in Windows machen (Rechte Maustaste -&gt; Senden an -&gt; zip komprimmierter Ordner). Um die Dateigröße aber möglichst klein zu halten ist es besser das Kommando <code>git archive</code> zu verwenden. Dieses wird keinen Dateien welche im <code>.gitignore</code> Ordner zur zip-Datei hinzufügen. Alle möglichen Buildartefakte aus dem target-Ordner, IntelliJ konfigurationen usw. kommen also garnicht erst ins zip. Mit</p>
<p><code>git archive HEAD --format=zip -o springproject.zip</code></p>
<p>bekommen wir vom aktuellsten commit weg (HEAD) eine Zip Datei (--format=zip) welche also springproject.zip (-o) gespeochert wird. Wenn wir das obige sftp-kommado nun starten kommt eine neue shell mit <code>&gt;</code> als Prompt.</p>
<p><img src="2022-10-31-18-30-51.png" alt=""></p>
<p>Mit dem ftp-Kommando <code>put &lt;pfad/dateiname&gt;</code> wird die datei in unser Homeverzeichnis auf der Oracel instanz hochgeladen.</p>
<p>Geht man jetzt wieder mit ssh in die Oracle Instanz und lässt sich mit ls alle Dateien anzeigen wird man die Datei vorfinden:</p>
<p><img src="2022-10-31-18-32-44.png" alt=""></p>
<p>Über das Kommando <code>unzip</code> kann man unter Ubuntu zip-Dateien entpachen. Dieses Programm (und docker) ist jedoch noch nicht installiert. Programme bzw. Pakete kann man in Ubuntu mit dem Paket-Verwaltungstool <code>apt</code> installieren. Beim ersten Start der Instanz muss man zunächst die Paketquellen aktualisieren. Das funktioniert mit:</p>
<p><code>sudo apt update -y</code></p>
<p>Sudo führt dazu das der nachfolgende Befehl mit Administratorrechten ausgefürt wird. Normalwerweise wird man dann gefragt ob man es wirklich installiern will, mit <code>-y</code> kann man diesen Schritt überspringen.</p>
<p>Ist alles geupdated können wir die für uns notwendigen Programme auf einmal alle mit</p>
<p><code>sudo apt install unzip docker docker-compose -y</code></p>
<p>installieren.</p>
<p>Ist alles installiert kann man nicht sofort unzip verwenden. Das Programm würde alles in den aktuellen Ordner entpacken. Mit <code>mkdir springproject</code> können wir einen neuen Ordner anlegen. Durch <code>mv &lt;deine-zip&gt;.zip springproject/&lt;deine-zip&gt;.zip</code> können wir die Datei in den neu erstellen unterordner schieben. Nun können wir mit <code>cd springproject</code> in den Ordner reingehen und mit <code>unzip &lt;deine-zip&gt;.zip</code> die Zipdatei entpacken.</p>
<p>Über docker-compose wird nun das Dockerfile aufgebaut. Im Docker-compose.yml ist einiges bereits vordefiniert. Wir müssen nur mit <code>sudo docker-compose up -d</code> den Container starten.</p>
<p>Sobald das Programm gestartet ist, ist es theoretisch von überall aus dem Internet erreichbar. Praktisch hat Oracle aber zu unserer Sicherheit noch eine Firewall eingebaut die wir zunächst locken müssen.</p>
<h2 id="firewall-konfigurieren">Firewall konfigurieren</h2>
<p>Unsere Firewall können wir via unserer virtuellen Netzwerkkarte (VNIC) konfigurieren. Dazu müssen wir unser Subnet editieren. Bei mir heisst es <code>subnetspring</code>.
<img src="2022-10-31-18-43-29.png" alt=""></p>
<p>In besagten subnet müssen wir bei den Security Lists einstellen welche Port von wo nach wo in welcher Range durchdürfen</p>
<p><img src="2022-10-31-18-45-31.png" alt=""></p>
<p>Dazu müssen wir eine neue Regel für eingehende Verbindungen (ingress rule) erstellen.
<img src="2022-10-31-18-46-16.png" alt=""></p>
<p>Durch die Quell-IP <code>0.0.0.0</code> mit dem Prefix <code>/0</code> geben wir an das die IP von überall kommen darf. In einer Perfekten Welt gäbe es eine IP-Gruppe für jedes Land. Dann könnten wir mit <code>43.0.0.0/0</code> z.B sagen das nur verbindungen aus Österreich erlaubt sind. In der Praxis müsste man das für jeden Provider machen wenn man das einstellen wollen würde. Das Feld für den Quellport lassen wir frei, damit sind alle erlaubt. Als Destination Port wählen wir Port 80. Den Port des HTTP-Protokolls. Spring operiert zwar auf port 8080, jedoch wurde in unserem Docker-compose alles von 8080 auf 80 umgeleitet.</p>
<p><img src="2022-10-31-18-48-34.png" alt=""></p>
<p>Nun da die Firewall eingestellt ist, der Server im Hintergrund läuft und auch sonst alles Reibungslos funktioniert hat können wir unsere API via HTTP aufrufen. Über Firefox bekommen wir auf unseren GET-Request z.B folgende Antwort (habe bei mir dann doch 8080 statt 80 verwendet):</p>
<p><img src="2022-10-31-18-53-56.png" alt=""></p>
<p>Um die Oracle-Server nicht unnötig zu belasten sollten wir unseren Server wenn wir ihn nicht brauchen auch wieder Herunterfahren. In der Instanzverwaltung dazu einfach auf den Stop-Button klicken und ein force-shutdown starten:
<img src="2022-10-31-19-01-04.png" alt=""></p>
<p>Über den Start-Button kann man die Instanz jederzeit wieder starten, sich mit SSH einloggen und weitermachen.
<img src="2022-10-31-19-01-34.png" alt=""></p>

</body>
</html>
